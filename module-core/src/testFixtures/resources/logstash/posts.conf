input {
  jdbc {
    jdbc_driver_library => "/tmp/mysql-connector-j-8.3.0.jar"
    jdbc_driver_class => "com.mysql.cj.jdbc.Driver"
    jdbc_connection_string => "jdbc:mysql://mysql:3306/testdb?serverTimezone=Asia/Seoul"
    jdbc_user => "root"
    jdbc_password => "test"
    lowercase_column_names => false
    schedule => "*/5 * * * * *"
    statement => "
      SELECT * FROM (
        SELECT
          p.id,
          p.channel,
          p.content,
          u.nickname AS authorNickname,
          COALESCE(GROUP_CONCAT(DISTINCT h.tag_name ORDER BY h.tag_name SEPARATOR ','), '') AS hashtags_csv,
          p.created_at AS createdAt,
          CASE WHEN p.status = 'ACTIVE' AND p.deleted_at IS NULL THEN 'index' ELSE 'delete' END AS es_action,
          GREATEST(
            p.updated_at,
            COALESCE(u.updated_at, TIMESTAMP('1970-01-01 00:00:00')),
            COALESCE(MAX(ph.updated_at), TIMESTAMP('1970-01-01 00:00:00')),
            COALESCE(MAX(h.updated_at), TIMESTAMP('1970-01-01 00:00:00'))
          ) AS sync_updated_at
        FROM posts p
        LEFT JOIN users u ON u.id = p.user_id
        LEFT JOIN post_hashtag ph ON ph.post_id = p.id
        LEFT JOIN hashtag h ON h.id = ph.hashtag_id
        GROUP BY p.id, p.channel, p.content, u.nickname, p.created_at, p.status, p.deleted_at, p.updated_at, u.updated_at
      ) t
      WHERE t.sync_updated_at > DATE_SUB(:sql_last_value, INTERVAL 3 SECOND)
      ORDER BY t.sync_updated_at ASC, t.id ASC
    "
    use_column_value => true
    tracking_column => "sync_updated_at"
    tracking_column_type => "timestamp"
    last_run_metadata_path => "/tmp/jdbc_last_run_posts.yml"
    clean_run => false
  }
}

filter {
  if [hashtags_csv] != "" { mutate { split => { "hashtags_csv" => "," } } }
  mutate {
    rename => { "hashtags_csv" => "hashtags" }
    add_field => { "[@metadata][es_action]" => "%{es_action}" }
    remove_field => ["es_action","sync_updated_at","@version"]
  }
}

output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "posts"
    document_id => "%{id}"
    action => "%{[@metadata][es_action]}"
  }
}
